import React, { useEffect, useMemo, useState } from "react";

// 飾品《決戰》1→12級 強化模擬器（M&X設計）
// 規則：失敗不降級；一次嘗試成本 = S[L] × (p/100)，成功機率 = p%。
// 使用說明：調整滑桿決定 p%，按「嘗試」進行強化；成功則升到下一級，失敗累計成本。

const DEFAULT_S: number[] = [38, 57, 66.5, 152, 180.5, 209, 323, 361, 399, 551, 589, 627];

function rand01() {
  // 安全亂數（瀏覽器）
  const u = new Uint32Array(1);
  if (typeof window !== "undefined" && window.crypto && window.crypto.getRandomValues) {
    window.crypto.getRandomValues(u);
    return u[0] / 2 ** 32;
  }
  // 後備：非加密安全
  return Math.random();
}

function fmt(n: number, digits = 2) {
  if (!Number.isFinite(n)) return "-";
  return n.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
}

export default function App() {
  const [S, setS] = useState<number[]>(DEFAULT_S);
  const [level, setLevel] = useState<number>(1); // 1..12，完成後 >12
  const [p, setP] = useState<number>(30); // 1..100
  const [total, setTotal] = useState<number>(0);
  const [attemptsCurr, setAttemptsCurr] = useState<number>(0);
  const [log, setLog] = useState<{
    id: number;
    level: number;
    p: number;
    cost: number;
    success: boolean;
    totalAfter: number;
  }[]>([]);
  // 新增：每級彙總（你要求的需求）
  const [levelSpend, setLevelSpend] = useState<number>(0); // 本級累計耗石
  const [successByLevel, setSuccessByLevel] = useState<{ level: number; spend: number; attempts: number }[]>([]);

  const finished = level > 12;
  const perTryCost = useMemo(() => (S[level - 1] ?? 0) * (p / 100), [S, level, p]);
  const expectedTotal = useMemo(() => S.reduce((a, b) => a + b, 0), [S]);

  function resetAll() {
    setLevel(1);
    setTotal(0);
    setAttemptsCurr(0);
    setLevelSpend(0);
    setSuccessByLevel([]);
    setLog([]);
  }

  function handleAttempt() {
    if (finished) return;
    const cost = perTryCost;
    const success = rand01() < p / 100;
    const newTotal = total + cost;
    const nextAttempts = attemptsCurr + 1;
    const nextLevelSpend = levelSpend + cost;

    setTotal(newTotal);
    setAttemptsCurr(nextAttempts);
    setLevelSpend(nextLevelSpend);
    setLog((prev) => [
      {
        id: prev.length + 1,
        level,
        p,
        cost,
        success,
        totalAfter: newTotal,
      },
      ...prev,
    ]);

    if (success) {
      // 成功後：記錄本級總花費與嘗試次數，然後升級並重置本級統計
      setSuccessByLevel((prev) => [...prev, { level, spend: nextLevelSpend, attempts: nextAttempts }]);
      setLevel(level + 1);
      setAttemptsCurr(0);
      setLevelSpend(0);
    }
  }

  function handlePChange(v: number) {
    if (!Number.isFinite(v)) return;
    const clamped = Math.max(1, Math.min(100, Math.round(v)));
    setP(clamped);
  }

  function updateCostAt(idx: number, val: number) {
    const next = [...S];
    next[idx] = Math.max(0, Number(val) || 0);
    setS(next);
  }

  function resetCosts() {
    setS(DEFAULT_S);
  }

  function downloadCSV() {
    if (log.length === 0 && successByLevel.length === 0) return;
    const rows1 = [
      ["#", "等級", "成功率(%)", "本次成本", "結果", "累積總耗"],
      ...[...log].reverse().map((r) => [r.id, r.level, r.p, r.cost.toFixed(2), r.success ? "成功" : "失敗", r.totalAfter.toFixed(2)]),
    ];
    const rows2 = [
      ["等級", "該級總花費(顆)", "嘗試次數"],
      ...successByLevel.map((s) => [s.level, s.spend.toFixed(2), s.attempts]),
    ];
    const csv = rows1.map((r) => r.join(",")).join("\n") + "\n\n" + rows2.map((r) => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "upgrade_log.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // 簡單自我測試（不影響 UI）：確保計算與 CSV 換行正確
  useEffect(() => {
    // 測試：每 1% 成本
    console.assert(Math.abs(DEFAULT_S[0] * 0.3 - 11.4) < 1e-9, "perTryCost 基本計算應為 11.4 當 p=30%" );
    // 測試：CSV 產生換行符號
    const csvTest = ["a,b", "c,d"].join("\n");
    console.assert(csvTest.includes("\n"), "CSV 應該使用\\n作為換行");
  }, []);

  return (
    <div className="min-h-screen bg-slate-50">
      <div className="max-w-6xl mx-auto p-4 md:p-6">
        <h1 className="text-2xl md:text-3xl font-bold tracking-tight">飾品《決戰》強化模擬器（遊戲版）</h1>
        <p className="text-slate-600 mt-1">規則：失敗不降級；一次嘗試成本 = S[L] × (p/100)；成功機率 = p%。</p>

        {/* Top summary cards */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <Stat label="目前等級" value={finished ? "+12 完成" : `+${level}`} accent={finished ? "text-emerald-600" : ""} />
          <Stat label="本次嘗試成功率" value={`${p}%`} />
          <Stat label="本次嘗試成本" value={`${fmt(perTryCost)} 顆`} />
          <Stat label="總耗鋒芒" value={`${fmt(total)} 顆`} />
        </div>

        {/* Controls */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
          {/* Left: action panel */}
          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-5">
            <h2 className="text-lg font-semibold">① 操作區</h2>

            {!finished ? (
              <div className="mt-3 space-y-3">
                <div>
                  <div className="flex items-center justify-between">
                    <label className="font-medium">調整本次成功率（%）</label>
                    <span className="text-sm text-slate-500">建議：前期 30%、後期 70–90%</span>
                  </div>
                  <div className="flex items-center gap-3 mt-2">
                    <input
                      type="range"
                      min={1}
                      max={100}
                      step={1}
                      value={p}
                      onChange={(e) => handlePChange(Number(e.target.value))}
                      className="w-full"
                    />
                    <input
                      type="number"
                      className="w-20 border rounded-xl px-2 py-1 text-right"
                      min={1}
                      max={100}
                      value={p}
                      onChange={(e) => handlePChange(Number(e.target.value))}
                    />
                    <span className="text-slate-500">%</span>
                  </div>
                </div>

                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={handleAttempt}
                    className="px-4 py-2 rounded-2xl bg-black text-white shadow hover:opacity-90"
                  >
                    嘗試（消耗 {fmt(perTryCost)} 顆）
                  </button>
                  <button
                    onClick={resetAll}
                    className="px-4 py-2 rounded-2xl bg-white border shadow-sm hover:bg-slate-50"
                  >
                    重置本輪
                  </button>
                </div>

                <div className="text-sm text-slate-600">本級已嘗試：{attemptsCurr} 次</div>

                {/* Progress */}
                <div className="mt-4">
                  <div className="flex items-center justify-between text-xs text-slate-500 mb-1">
                    <span>強化進度</span>
                    <span>期望總耗（Σ S[L]）：{fmt(expectedTotal)}</span>
                  </div>
                  <div className="grid grid-cols-12 gap-1">
                    {Array.from({ length: 12 }).map((_, i) => {
                      const passed = i + 1 < level || finished;
                      const active = i + 1 === level && !finished;
                      return (
                        <div
                          key={i}
                          className={
                            "h-3 rounded-full " +
                            (passed
                              ? "bg-emerald-500"
                              : active
                              ? "bg-blue-500"
                              : "bg-slate-300")
                          }
                          title={`+${i + 1}`}
                        />
                      );
                    })}
                  </div>
                </div>
              </div>
            ) : (
              <div className="mt-4 p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                <div className="text-emerald-700 font-semibold">恭喜！已達成 +12</div>
                <div className="text-slate-700 mt-1">本輪總共消耗：<span className="font-semibold">{fmt(total)} 顆鋒芒石</span></div>
                <div className="mt-3">
                  <button
                    onClick={resetAll}
                    className="px-4 py-2 rounded-2xl bg-black text-white shadow hover:opacity-90"
                  >
                    再來一輪
                  </button>
                  <button
                    onClick={downloadCSV}
                    className="ml-2 px-4 py-2 rounded-2xl bg-white border shadow-sm hover:bg-slate-50"
                  >
                    下載本輪紀錄 CSV
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* Right: costs editor & info */}
          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-5">
            <h2 className="text-lg font-semibold">② 成本表（100% 成功所需鋒芒石）</h2>
            <div className="text-sm text-slate-600">可依你的版本自行調整，支援小數；重置可恢復預設值。</div>

            <div className="mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
              {S.map((val, idx) => (
                <div key={idx} className="flex items-center gap-2 border rounded-xl px-3 py-2">
                  <div className="w-10 text-slate-500 text-sm">+{idx + 1}</div>
                  <input
                    type="number"
                    min={0}
                    step={0.1}
                    value={val}
                    onChange={(e) => updateCostAt(idx, Number(e.target.value))}
                    className="flex-1 text-right border rounded-lg px-2 py-1"
                  />
                </div>
              ))}
            </div>

            <div className="flex flex-wrap gap-2 mt-3">
              <button onClick={resetCosts} className="px-3 py-2 rounded-2xl bg-white border shadow-sm hover:bg-slate-50">重設成本</button>
              <div className="text-sm text-slate-600 flex items-center">合計（Σ S[L]）：<span className="font-semibold ml-1">{fmt(expectedTotal)}</span></div>
            </div>

            <div className="mt-6">
              <h3 className="font-semibold mb-2">③ 歷程紀錄</h3>
              <div className="text-sm text-slate-600 mb-2">顯示最近 50 筆（完整紀錄可用「下載 CSV」匯出）</div>
              <div className="overflow-auto border rounded-2xl">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="bg-slate-100 text-slate-700">
                      <th className="px-3 py-2 text-left">#</th>
                      <th className="px-3 py-2 text-left">等級</th>
                      <th className="px-3 py-2 text-left">成功率(%)</th>
                      <th className="px-3 py-2 text-left">本次成本</th>
                      <th className="px-3 py-2 text-left">結果</th>
                      <th className="px-3 py-2 text-left">累積總耗</th>
                    </tr>
                  </thead>
                  <tbody>
                    {log.slice(0, 50).map((r) => (
                      <tr key={r.id} className="border-t">
                        <td className="px-3 py-2">{r.id}</td>
                        <td className="px-3 py-2">+{r.level}</td>
                        <td className="px-3 py-2">{r.p}%</td>
                        <td className="px-3 py-2">{fmt(r.cost)}</td>
                        <td className="px-3 py-2">
                          <span className={r.success ? "text-emerald-600" : "text-rose-600"}>{r.success ? "成功" : "失敗"}</span>
                        </td>
                        <td className="px-3 py-2">{fmt(r.totalAfter)}</td>
                      </tr>
                    ))}
                    {log.length === 0 && (
                      <tr>
                        <td className="px-3 py-4 text-slate-500" colSpan={6}>尚無紀錄，請調整成功率並按「嘗試」。</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              <div className="mt-6">
                <h3 className="font-semibold mb-2">④ 升級總結（每級）</h3>
                <div className="text-sm text-slate-600 mb-2">每次成功後，紀錄該級自 0→該級的總花費與本級嘗試次數。</div>
                <div className="overflow-auto border rounded-2xl">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="bg-slate-100 text-slate-700">
                        <th className="px-3 py-2 text-left">等級</th>
                        <th className="px-3 py-2 text-left">該級總花費(顆)</th>
                        <th className="px-3 py-2 text-left">嘗試次數</th>
                      </tr>
                    </thead>
                    <tbody>
                      {successByLevel.length > 0 ? (
                        successByLevel.map((s) => (
                          <tr key={s.level} className="border-t">
                            <td className="px-3 py-2">+{s.level}</td>
                            <td className="px-3 py-2">{fmt(s.spend)}</td>
                            <td className="px-3 py-2">{s.attempts}</td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td className="px-3 py-4 text-slate-500" colSpan={3}>尚無成功紀錄</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="mt-6 text-xs text-slate-500">
          備註：本工具不使用外部資料來源；若未來要加入法規或其他數據，我會依你的規範使用最新年份並標註來源與年份。
        </div>
      </div>
    </div>
  );
}

function Stat({ label, value, accent = "" }: { label: string; value: string; accent?: string }) {
  return (
    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
      <div className="text-slate-500 text-sm">{label}</div>
      <div className={`text-xl font-semibold mt-1 ${accent}`}>{value}</div>
    </div>
  );
}
